---
title: ""
output: 
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: none
    toc: FALSE
    toc_float: FALSE
    css: !expr here::here("www", "web_report_trust.css")
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{=html}
<style>
@import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300&display=swap');
</style>
```
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather" />

```{r, echo=FALSE, fig.align='center'}
knitr::include_graphics(here::here("www", "images", "CCT_logo_centered_blue-new.jpg"), dpi = 500)
```

<center>

<h1>DRAFT Federal Funds Tracker</h1>

**This dashboard is a draft that is undergoing active development. It should not be shared or used for analysis. The most recent published version of the dashboard can be found [here](https://chi-trust.github.io/Recovery-Funds-Dashboard/index.html)**

</center>

Federal COVID-19 pandemic response packages have provided state and local governments with unprecedented aid. The impact of these resources will directly result from how they are spent and in which communities. Given this unparalleled opportunity to ensure federal funds reach communities that need them most and propel momentum toward closing the racial and ethnic wealth gap, this dashboard aims to provide transparency on where funds are landing.

```{r}
#| echo: false
#| include: false

knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(fig.height = 4)
knitr::opts_chunk$set(fig.width = 6)

library(tidyverse)
library(here)
library(urbnthemes)
library(plotly)
set_urbn_defaults(style = "print", base_size = 12)

# read infrastructure data
inf_data <- read_csv(here("data/intermediate_data", 
                          "inf_data_clean.csv")) %>%
  mutate(legislation = "IIJA")  %>%
  select(final_allocation = amount, legislation, recipient_name = summary_recipient)

# read recovery data
rec_data <- read_csv(here("data/intermediate_data",
                          "clean_data_dashboard.csv")) %>%
  rename("recipient_name" = "geography", 
         "final_allocation" = "allocation") %>%
  mutate(recipient_name = if_else(recipient_name == "Chicago", 
                                  "City of Chicago", 
                                  recipient_name)) %>%
  select(final_allocation, legislation, recipient_name) 


all_data <- rbind(inf_data, rec_data) %>%
  mutate(legislation = case_when(
    legislation == "ARPA State and Local Fiscal Recovery Funds" ~
       "ARPA State and Local\nFiscal Recovery Funds",
    legislation == "Chicago General Obligation Bond" ~
      "Chicago General\nObligation Bond",
    TRUE ~ legislation
  ))

```

```{r}
plot_funds_by_var <- function(data, fill_var, lab_text){
  
  data <- data %>%
    mutate(final_allocation = final_allocation / 1000000)
  
  fill_var <- enquo(fill_var)
  
  var_levels <- data %>%
    group_by(!!fill_var) %>% 
    summarise(total_allocation = sum(final_allocation, na.rm = TRUE)) %>%
    arrange(total_allocation) %>% 
    pull(!!fill_var) %>% 
    unique()
 
 
  fill_breaks <- data %>%
     pull(!!fill_var) %>%
     unique()
  
  if (length(fill_breaks) > 6) {
    fill_values <- rep(c("#47c3d3"), each = length(fill_breaks))
  } else {
    fill_values <- c("#47c3d3", "#C1D82F", "#6C5893", "#000000", 
                    "#387ECF", "#FDBB30")[1:length(fill_breaks)]
  }
   
  
  allocations_by_var <- data %>% 
    group_by(!!fill_var) %>%
    summarise(final_allocation = sum(final_allocation, na.rm = TRUE)) %>%
    mutate(allocation_str = scales::dollar(final_allocation),
           label_height = cumsum(final_allocation),
           !!fill_var := factor(!!fill_var, levels = var_levels)) %>% 
    ggplot() +
    geom_col(mapping = aes(x = !!fill_var, 
                                  y = final_allocation, 
                                  fill = !!fill_var,
                                  text = allocation_str)) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.01)), 
                     labels = scales::dollar) +
    scale_fill_manual(values = fill_values,
                      breaks = fill_breaks)+
    labs(x = lab_text, 
         y = "Total Allocation (millions)",
         caption = "This graph shows selected projects funded through ARPA, CARES, CRRSAA, and IIJA. For more detail, see the FAQ.") +
    coord_flip() +
    theme(text = element_text(family = "Merriweather",
                              face = "plain",
                                 colour = "#000000",
                                 size = 8,
                                 hjust = 0.5,
                                 vjust = 0.5,
                                 angle = 0,
                                 lineheight = 0.9,
                                 margin = ggplot2::margin(),
                                 debug = FALSE),
          legend.position = "none",
          axis.text.y = element_text(family = "Merriweather",
                              face = "plain",
                                 colour = "#000000",
                                 size = 9,
                                 hjust = 0.5,
                                 vjust = 0.5,
                                 angle = 0,
                                 lineheight = 0.9,
                                 margin = ggplot2::margin(),
                                 debug = FALSE),
          axis.text.x = element_text(family = "Merriweather",
                              face = "plain",
                                 colour = "#000000",
                                 size = 9,
                                 hjust = 0.5,
                                 vjust = 0.5,
                                 angle = 0,
                                 lineheight = 0.9,
                                 margin = ggplot2::margin(),
                                 debug = FALSE),
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0))
  
  return(allocations_by_var)
}

```

# Total Dollars Tracked {.tabset .tabset-pills}

## By Legislation

```{r}
#| fig-width: 9
#| fig-height: 4
#| fig-alt: "TBD"
plot_funds_by_var(all_data, legislation, "Legislation")

```

## By Recipient

```{r}
#| fig-width: 9
#| fig-height: 4
#| fig-alt: "TBD"
plot_funds_by_var(all_data, recipient_name, "Recipient")

```

# About the Dashboard

```{r, eval = FALSE}

zip::zip(zipfile = here("data/dashboard_downloads", "all_dashboard_data.zip"),
         files = c(
           "data/intermediate_data/recovery_dashboard_data.csv",
           "data/intermediate_data/infrastructure_dashboard_data.csv",
           "docs/recovery_data_dictionary.csv",
           "docs/infrastructure_data_dictionary.csv"
           )
  )
  
  put_object(file = here("data/dashboard_downloads", "all_dashboard_data.zip"),
             bucket = bucket_name,
             object = "all_dashboard_data.zip")

```

The funds we tracked represent two streams of federal dollars flowing to Illinois: [economic recovery funds](./recovery-funds.html) and [infrastructure funds](./infrastructure-funds.html). By adding clarity around how federal funds are being disbursed locally and for what purposes, we can begin to understand and hold ourselves collectively responsible for ensuring the Chicago region recovers equitably and inclusively.  

As new data becomes available, more program allocation and spending information will be added. For more information, see our [Frequently Asked Questions](./FAQ.html) and [Glossary](./glossary.html).

For more information about the dashboard, please contact [Aimee Ramirez](mailto:aramirez@cct.org) (The Chicago Community Trust) and [Karolina Ramos](mailto:kramos@urban.org) (Urban Institute).

[Download all the data used in the dashboard (.zip)](https://federal-funds-equity.s3.amazonaws.com/all_dashboard_data.zip)

The code used to create this dashboard can be found on [GitHub](https://github.com/Chi-Trust/Recovery-Funds-Dashboard).

This project is a collaboration between [The Chicago Community Trust](https://www.cct.org/) and the [Urban Institute](https://www.urban.org/). It is supported by a grant from the Kresge Foundation through the [Shared Prosperity Partnership](http://www.sharedprosperitypartnership.org/).